# 1.背景
光纤通信领域的大型嵌入式设备，如接入网OLT，传送网OSN，家庭宽带ONT等等，都需要针对客户的业务诉求交付对应的命令行，以进行业务配置，比如专网，专线，用户带宽限制等，命令行的开发也是业务交付的一部分，下面列举几个典型的OLT设备的命令：
```
display board 0  // 查看单板状态
display vlan all // 查看所有vlan
display ont autofind all  // 查看所有自动发现的ont
dba-profile add profile-id 200 type4 max 1024000  // 创建dba模板
ont-lineprofile gpon profile-id 20 profile-name "Internet"  // 创建线路模板
...
```
交付客户的命令行有很多，上面只是简单列举几个，其他还有基础配置、VLAN配置、DBA模板配置、线路模板配置、业务模板配置、ONT注册配置、业务端口配置、组播业务配置、语音业务配置等，所有的这些命令行可以涵盖OLT设备所支持的全部协议。

除了上述需要交付客户的命令行，每个领域或组件都会有自己的DEBUG命令行，这些命令行在开发阶段可以常态打开，方便进行业务验证和问题定位，等到了项目的某个节点，如TR5节点，就必须裁剪掉。所有的交付命令行都必须体现到交付客户的命令行手册中，否则视为预留后门。
作为偏向底层的驱动领域，业务层属于上层，有专门的业务团队负责，所以一般交付命令行都是由上层实现，驱动层最多提供一些必要接口或数据。在驱动层开发的命令行基本上都是DEBUG命令行，这里我们也是关注DEBUG命令行。

# 2.命令树
命令行可以看作是一个多叉树，从根节点出发，每个节点都有N个子节点，这些子节点又会有自己的子节点，这些子节点可以是字符串，也可以是数据（整形，浮点等）。整个二叉树的子节点上需要挂接执行函数，当我们在命令行界面敲下整个命令时，系统需要检索多叉树，如果可以正确找到某个子节点，则执行该子节点上的执行函数，并将命令中的参数作为函数入参。
当然，中间节点也可以挂接执行函数，总的来说，只要根据用户输入的命令完整检索多叉树并找到了一个节点，且该节点挂接了执行函数，就会执行该函数。如果检索后找到了节点但是未挂接执行函数，则屏幕打印提示信息并返回成功。

## 2.1 节点
如1中的例子，命令行的输入文本可以根据空格来拆分成多个节点信息，那么对于一个节点，应当包含以下信息：
1.节点数据类型。有些节点的数据类型是字符串，如"display"，还有一些节点是具体数据，如"200"，那么在命令树中要明确指定节点类型，以便于和输入作比较或存储
2.描述信息。当用户不清楚接下来要输入什么时，直接按回车应该显示提示信息，用于提示下一个节点需要输入的内容。
3.范围限制。如果需要输入整形数据，可能需要做范围校验，比如上例中的VLAN，如果最大就是200，那么用户输入300就不符合预期，需要进行校验。但是这个校验也可以在最终的执行函数中进行，主要是依据项目特性，如果某些数据的范围很稳定，那么放到节点中校验更合适，如果是动态的范围，那么放到执行函数中校验更合适。
4.子节点列表。当前节点的所有子节点。如果用户在当前节点后直接回车，命令行系统应该显示该节点的所有子节点以提示用户进一步输入。
5.执行函数。是命令行功能的实现函数，用来完成根据用户输入数据进行配置查询，版本号显示，配置下发等任务。通常是挂在树的末端子节点，但是中间节点也可以挂接。

## 2.2 接口
命令树和链表类似，是一个递归的结构，即结构体成员中又包含了该结构体。
```
typedef enum {
    STRING,
    INTEGER,
    FLOAT,
    DOUBLE
} CmdNodeType;

typedef struct {
    double data[CMD_DATANUM_MAX];
    uint32_t inputDataNum;
} CmdInput;
typedef uint32_t (*CmdExec)(CmdInput *input);

struct CmdNode {
    CmdNodeType nodeType; /**< 节点类型 */
    char *nodeName; /**< 节点名称，只有当节点类型是STRING时才使用 */
    char *desc; /**< 节点描述信息 */
    uint32_t childNum; /**< 节点孩子数量 */
    CmdNode *child; /**< 节点孩子 */
    CmdExec exec; /**< 节点执行函数 */
};
```

## 2.3 显示
命令行的功能实现通过节点的执行函数CmdNode.exec实现，一般我们都希望命令行的执行结果能够直观呈现，所以不管是查询类命令，还是设置类命令，都需要直接将结果进行屏幕输出。
命令行的输出必须要站在使用者的角度考虑，比如如果查询到的原始数据需要处理，则最好在执行函数中处理之后在打印，而不是直接将原始数据打印出来。
此外，输出的排版也要尽可能做到直观且明确，要有详细的提示信息。

## 2.4 界面
命令行界面最好有明确的提示信息，提示用户当前处于命令行模式，并且要引导用户输入命令，需要一些特殊的符号，类似于Linux终端上都有一个$来提示用户此处可以输入命令。界面设计如下：
当软件拉起，进入命令行模式时，要显式打印提示信息：
`-------------------------CMD MODE------------------------------`
用户输入提示可以使用`>>`，命令行界面的每一行开头都要打印一个`>>`